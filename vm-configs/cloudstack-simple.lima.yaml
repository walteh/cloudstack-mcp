# Simple Lima Configuration for CloudStack
# Minimal configuration for CloudStack testing

# VM specs
arch: "aarch64"
cpus: 4
memory: 8GiB
disk: 40GiB

# Use Ubuntu LTS image for ARM64
images:
    - location: "https://cloud-images.ubuntu.com/jammy/current/jammy-server-cloudimg-arm64.img"
      arch: "aarch64"

# Use Virtualisation.framework on Mac
vmType: "vz"

# Mount home directory
mounts:
    - location: "~"
      writable: true

# SSH configuration
ssh:
    localPort: 0
    loadDotSSHPubKeys: true

# Basic provision script to install CloudStack dependencies
provision:
    - mode: system
      script: |
          #!/bin/bash
          set -e

          # Update system
          apt-get update
          apt-get install -y qemu-kvm libvirt-daemon-system libvirt-clients
          apt-get install -y nfs-kernel-server

          # Configure libvirt
          cat > /etc/libvirt/libvirtd.conf << EOF
          listen_tls = 0
          listen_tcp = 1
          tcp_port = "16509"
          auth_tcp = "none"
          EOF

          # Setup CloudStack dirs
          mkdir -p /export/primary /export/secondary
          mkdir -p /etc/cloudstack/agent

          # Enable libvirt
          systemctl enable libvirtd
          systemctl restart libvirtd

# Use vzNAT networking
networks:
    - vzNAT: true

# Port forwarding
portForwards:
    - guestPort: 16509
      hostPort: 16509
    - guestPort: 8250
      hostPort: 8250

# Startup message
message: |
    CloudStack VM is ready!

    Commands:
    - SSH: lima ssh cloudstack-simple
    - Shell: lima shell cloudstack-simple
