# Simple Lima Configuration for CloudStack
# This configuration minimizes dependencies and should work on any Mac

# VM specs
arch: "default"
cpus: 4
memory: 8GiB
disk: 40GiB

# Use Ubuntu 22.04 as the base OS
images:
    - location: "https://cloud-images.ubuntu.com/releases/22.04/release/ubuntu-22.04-server-cloudimg-amd64.img"
      arch: "x86_64"

# Standard VM settings
vmType: "qemu"
rosetta:
    enabled: true

# Keep the VM running in the background
persistent: true

# Mount user home by default
mounts:
    - location: "~"
      writable: true

# SSH configuration
ssh:
    localPort: 0
    loadDotSSHPubKeys: true

# Basic provision script to install CloudStack dependencies
provision:
    - mode: system
      script: |
          #!/bin/bash
          set -eux -o pipefail
          export DEBIAN_FRONTEND=noninteractive

          # Ensure system is up to date
          apt-get update
          apt-get upgrade -y

          # Install essential packages
          apt-get install -y qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils
          apt-get install -y nfs-kernel-server openjdk-11-jre-headless ethtool
          apt-get install -y iptables ebtables

          # Configure libvirt
          cat > /etc/libvirt/libvirtd.conf << EOF
          listen_tls = 0
          listen_tcp = 1
          tcp_port = "16509"
          mdns_adv = 0
          auth_tcp = "none"
          EOF

          # Create directories for CloudStack storage
          mkdir -p /export/primary /export/secondary

          # Create CloudStack agent directory
          mkdir -p /etc/cloudstack/agent

          # Make sure libvirt is started
          systemctl enable libvirtd
          systemctl restart libvirtd

# Use the simplest network mode
networks:
    - lima: default

# Port forwards for CloudStack services
portForwards:
    - guestPort: 16509
      hostPort: 16509
    - guestPort: 8250
      hostPort: 8250

# Instructions message
message: |
    CloudStack VM is ready!

    Use the following commands to interact with the VM:
    - SSH into VM: lima ssh cloudstack-simple
    - Run shell commands: lima shell cloudstack-simple
    - Stop VM: limactl stop cloudstack-simple
